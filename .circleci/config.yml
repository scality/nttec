version: 2.0
jobs:
  build:
    docker:
      - image: slaperche0scality/quadiron:latest
    steps:
      - checkout
      - run:
          name: Compile with Clang 6 (Debug mode)
          command: >
            rm -rf build && mkdir build && cd build &&
            CXX=/usr/bin/clang++-6.0 cmake -G 'Unix Makefiles' .. -DCMAKE_BUILD_TYPE=Debug .. &&
            make
      - run:
          name: Compile with Clang 6 (Release+SIMD mode)
          command: >
            rm -rf build && mkdir build && cd build &&
            CXX=/usr/bin/clang++-6.0 cmake -G 'Unix Makefiles' .. -DCMAKE_BUILD_TYPE=Release -DQUADIRON_USE_SIMD=ON .. &&
            make
      - run:
          name: Compile with GCC 8 (Debug mode)
          command: >
            rm -rf build && mkdir build && cd build &&
            CXX=/usr/bin/g++-8 cmake -G 'Unix Makefiles' .. -DCMAKE_BUILD_TYPE=Debug.. &&
            make
      - run:
          name: Compile with GCC 8 (Release+SIMD mode)
          command: >
            rm -rf build && mkdir build && cd build &&
            CXX=/usr/bin/g++-8 cmake -G 'Unix Makefiles' .. -DCMAKE_BUILD_TYPE=Release -DQUADIRON_USE_SIMD=ON .. &&
            make
  test:
    docker:
      - image: slaperche0scality/quadiron:latest
    steps:
      - checkout
      - run: mkdir build && cd build && cmake -G 'Unix Makefiles' .. -DCMAKE_BUILD_TYPE=Release -DQUADIRON_USE_SIMD=ON 'Unix Makefiles' .. && make
      - run: cd build && make check-format
      - run: cd build && make check-lint
      - run: cd build && make check
      - run: cd build && make benchmark
